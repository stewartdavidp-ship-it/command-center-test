---
task: "Implement multi-user mode: UID-scoped data, SecretManager, setup wizard"
status: complete
cc-spec-id: null
app: command-center
files:
  - path: "index.html"
    action: modified
    lines: "+462 -32"
commits:
  - sha: "36919f5"
    message: "Multi-user mode: UID-scoped data, SecretManager, setup wizard (v8.70.0)"
    repo: "stewartdavidp-ship-it/command-center-test"
odrc:
  new_decisions:
    - "SecretManager namespaces secrets as cc_{base}_{uid} with fallback reads for pre-migration compat"
    - "Legacy un-namespaced secrets deleted after migration to prevent second-user leak"
    - "FirebaseConfigSync._ref() returns null when no UID, all callers guard with null check"
    - "Three-state render gate: SignInScreen -> SetupWizard -> Main UI"
    - "GitHub token is the minimum viable credential for setup completion"
    - "Setup wizard is 3 steps: Welcome, GitHub Token (required), API Keys + Done (optional)"
    - "StorageManager.isProtected() uses prefix matching for UID-namespaced secret keys"
    - "Startup sync useEffect depends on firebaseUid to defer until auth resolves"
    - "Firebase security rules deployed manually AFTER first migration"
  resolved_opens: []
  new_opens:
    - "Firebase security rules need manual deployment via Firebase Console after confirming migration"
    - "Legacy global data in Firebase not auto-deleted after migration — manual cleanup needed later"
unexpected_findings:
  - "462 insertions vs ~283 planned — extra lines from SignInScreen/SetupWizard being more detailed than estimated"
  - "StorageManager aggressive cleanup (line 1033) would have deleted namespaced secrets — caught and fixed with isProtected() prefix matching"
unresolved: []
---

## Summary

Transformed Command Center from a single-user app into a multi-user app. Each Firebase-authenticated user now has isolated data paths and browser-local secrets.

## Architecture

### SecretManager (inserted after StorageManager)
- Namespaces all secret localStorage keys by Firebase UID: `cc_{base}_{uid}`
- BASE_KEYS: token, token_expires, anthropic_api_key, firebase_sa
- MIRROR_MAP: mirrors token→gs_github_token, firebase_sa→gs_firebase_sa for satellite apps
- `migrateFromGlobal()`: copies legacy un-namespaced keys to namespaced, deletes originals

### FirebaseConfigSync UID Scoping
- Added `uid` property, `setUid()`, `_ref(dataKey)` helper
- All 6 ref callsites updated to use `_ref()` with null guards
- `migrateFromGlobal()`: copies all 6 data keys from `command-center/{dataKey}` to `command-center/{uid}/{dataKey}`

### Auth Flow
- `onAuthStateChanged` now wires SecretManager.setUid + FirebaseConfigSync.setUid
- Runs secret migration and Firebase migration on sign-in
- Hydrates githubToken from namespaced storage
- Checks setupComplete (has GitHub token)
- Sign-out: clears UIDs, resets setupComplete, preserves localStorage secrets

### Three-State Render Gate
- `!firebaseUid` → SignInScreen (Google sign-in prompt)
- `firebaseUid && !setupComplete` → SetupWizard (3-step onboarding)
- `firebaseUid && setupComplete` → Main UI (existing header + views)

### Setup Wizard
- Step 1: Welcome with Google avatar/name
- Step 2: GitHub token validation (calls GitHub API, shows user info)
- Step 3: Optional API keys + summary + "Launch Command Center"

### StorageManager Fix
- Added `isProtected(key)` method with prefix matching for `cc_token_`, `cc_token_expires_`, etc.
- Prevents aggressive cleanup from deleting UID-namespaced secret keys

## Firebase Security Rules (Manual — Phase E)
Deploy AFTER first sign-in (so migration runs):
```json
{
  "rules": {
    "command-center": {
      "$uid": {
        ".read": "auth.uid === $uid",
        ".write": "auth.uid === $uid"
      }
    }
  }
}
```
